import { NextRequest, NextResponse } from 'next/server';
import { getAiSystemPrompt } from '@/lib/utils';

export async function POST(req: NextRequest) {
  try {
    const { title, description, language } = await req.json();
    const lang = (language === 'hi' ? 'hi' : 'en') as 'en'|'hi';

    const key = process.env.OPENAI_API_KEY;
    if (key) {
      const sys = getAiSystemPrompt(lang);
      const user = lang === 'hi'
        ? `?????? ??????: ${title}\n?????: ${description}\n????? ???-??-???, ?????????? ?????? ????`
        : `Problem Title: ${title}\nDescription: ${description}\nProvide step-by-step, actionable suggestions.`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${key}`,
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: sys },
            { role: 'user', content: user },
          ],
          temperature: 0.7,
        }),
      });
      const json = await response.json();
      const suggestion = json.choices?.[0]?.message?.content ?? 'No suggestion.';
      return NextResponse.json({ suggestion });
    }

    // Fallback heuristic suggestion
    const suggestion = lang === 'hi' ?
      `????????? ?????:\n1) ?????? ?? ???? ????? ??? ???????\n2) 80/20 ???? ???? ???? ? ???? ?????? ??? ?????\n3) 2-3 ???????? ?????? ????? ?? ????? ?????? ?????\n4) ?????/???????? ???? ??????\n???? ???:\n- ??: ???? ???? ?????? ?????\n- 1 ??????: ?????? ?????, ???? iteration ?? ?????? ????` :
      `Concise plan:\n1) Break the problem into smaller chunks.\n2) Apply the 80/20 rule ? high-impact first.\n3) Draft 2-3 alternatives and run quick experiments.\n4) List risks/dependencies with mitigations.\nNext steps:\n- Today: run the smallest viable experiment.\n- 1 week: measure results and pick the next iteration.`;

    return NextResponse.json({ suggestion });
  } catch (e) {
    return NextResponse.json({ error: 'Bad Request' }, { status: 400 });
  }
}
